package com.example.yblog.login.service;

import com.example.yblog.model.BanEmail;
import com.example.yblog.model.YUser;
import com.example.yblog.repository.*;
import lombok.extern.log4j.Log4j2;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.Optional;

@Log4j2
@Service
public class LoginService {

    @Autowired
    YUserRepository yUserRepository;

    @Autowired
    YBoardRepository yBoardRepository;

    @Autowired
    YReplyRepository yReplyRepository;

    @Autowired
    BanEmailRepository banEmailRepository;


    @Autowired
    BRLRepository brlRepository;

    @Transactional(readOnly = true)
    public  YUser findEmail(String email){
            return yUserRepository.findByEmail(email)
                    .orElseThrow(()-> new IllegalArgumentException("없는 사용자 입니다"));

    }

    @Transactional(readOnly = true)
    public YUser findUsername(String username){
        return yUserRepository.findByUsername(username)
                .orElseThrow(()->new IllegalArgumentException("없는 닉네임의 사용자입니다"));
    }

    @Transactional
    public void deleteUser(YUser yUser){
        Optional<YUser> localyUser = yUserRepository.findByUsername(yUser.getUsername());
        if(localyUser.isEmpty()){
            log.info("Fail DeleteUser find not User");
        }else{
            brlRepository.deleteAllByUser(localyUser.get());
            yReplyRepository.deleteAllByUser(localyUser.get());
            yBoardRepository.deleteAllByUser(localyUser.get());
            yUserRepository.deleteById(localyUser.get().getId());
        }

    }

    public boolean checkBanEmail(String email){
        Optional<BanEmail> banEmail = banEmailRepository.findById(email);

        if(banEmail.isEmpty()){
            return  false; // 벤을 체크하는 거니깐 0으로 반환 벤 안당한 아이디라는 뜻
        }

        return true;
    }




    // 스프링 부트 시큐리티 사용으로 인한 아래 로그인 함수 삭제

  /*  // 이 유저값 자체를 리턴해준다
    @Transactional(readOnly = true) // select할때 트랜잭션 시작, 서비스 종료시 트랜잭션종료 (정합성 유지)
    public YUser loginUser(YUser yUser){
        return yUserRepository.findByUsernameAndPassword(yUser.getUsername(), yUser.getPassword());
    }*/



}
